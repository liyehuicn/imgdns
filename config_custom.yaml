#mosdns5.3.3自定义配置
log:
  level: info
  # file: "/var/log/mosdns.log"

api:
  http: "0.0.0.0:9091"

plugins:
  # 规则集（保持不变）
  - tag: cache
    type: cache
    args:
      size: 10240               # 缓存条数。建议设为 10240，占用内存极小但命中率高
      lazy_cache_ttl: 86400     # 开启懒缓存24小时。过期后先返回旧 IP 保证秒开，同时后台更新
      dump_file: "/var/mosdns/cache.dump" # 重启后自动加载之前的缓存，无需重新预热
      
  - tag: geosite_cn
    type: domain_set
    args:
      files:
        - "/var/mosdns/geosite_cn.txt"

  - tag: geosite_geolocation-!cn
    type: domain_set
    args:
      files:
        - "/var/mosdns/geosite_geolocation-!cn.txt"

  - tag: geoip_cn
    type: ip_set
    args:
      files:
        - "/var/mosdns/geoip_cn.txt"

  # 上游（建议都用DoH/DoT加密，防中间人/运营商嗅探）
  - tag: domestic_forward
    type: forward
    args:
      concurrent: 3
      upstreams:
        - addr: "https://doh.pub/dns-query"
          dial_addr: "1.12.12.12"
          idle_timeout: 300
        - addr: "https://223.6.6.6/dns-query"
          idle_timeout: 300
        - addr: "https://223.5.5.5/dns-query"
          idle_timeout: 300
  - tag: remote_forward
    type: forward
    args:
      concurrent: 3
      upstreams:
        - addr: "https://security.cloudflare-dns.com/dns-query"
          idle_timeout: 60
        - addr: "https://dns.google/dns-query"
          dial_addr: "8.8.8.8"
          idle_timeout: 60

  # 只用于国内域名的查询序列（可加防污染也可不加）
  - tag: query_local
    type: sequence
    args:
      - exec: prefer_ipv4
      - exec: "$domestic_forward"
      # 可选：防污染（但因为明确是geosite:cn域名，通常污染少）
      # - matches: "!resp_ip $geoip_cn"
      #   exec: drop_resp

  # 国外/未知域名的查询序列（直接远程）
  - tag: query_remote
    type: sequence
    args:
      - exec: prefer_ipv4
      - exec: "$remote_forward"

  # 主逻辑（最关键修改在这里）
  - tag: main
    type: sequence
    args:
      # 禁用 IPv6
      - matches: qtype 28
        exec: reject

      # 缓存
      - exec: "$cache"

      # 1️⃣ 明确国内域名
      - matches: qname $geosite_cn
        exec: "$query_local"
      - matches: has_resp
        exec: accept

      # 2️⃣ 明确国外域名
      - matches: qname $geosite_geolocation-!cn
        exec: "$query_remote"
      - matches: has_resp
        exec: accept

      # 3️⃣ 未知域名 → 先国内
      - exec: "$query_local"

      # 4️⃣ 如果是国内 IP → 接受
      - matches: resp_ip $geoip_cn
        exec: accept

      # 5️⃣ 否则丢弃污染结果
      - exec: drop_resp

      # 6️⃣ 再走国外
      - exec: "$query_remote"

  # 服务器监听（建议用非53端口防意外泄漏到系统DNS）
  - tag: udp_server
    type: udp_server
    args:
      entry: main
      listen: "0.0.0.0:5335"

  - tag: tcp_server
    type: tcp_server
    args:
      entry: main
      listen: "0.0.0.0:5335"
